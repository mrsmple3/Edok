# Auth Middleware - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–ø–∏—Å–∞–Ω–∏–µ

`auth.global.ts` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Nuxt. Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞—â–∏—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

- **–û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**: middleware –∂–¥–µ—Ç –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `userStore.initAuth()` –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- **–ù–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∫ —Ñ–ª–∞–≥ `isAuth`, —Ç–∞–∫ –∏ –Ω–∞–ª–∏—á–∏–µ `user.id`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PageLoader

- **–ü–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç loader –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–°–∫—Ä—ã—Ç–∏–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ**: loader –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **UX –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: loader –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

### ‚úÖ –£–º–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è

- **–ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**: `/login` –∏ `/register` –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç**: –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ `/login`
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ø–æ—Å–ª–µ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏)

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

```typescript
export default defineNuxtRouteMiddleware(async (to, from) => {
	// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
	const publicPages = ["/login", "/register"];
	const isPublicPage = publicPages.some((page) => to.path.startsWith(page));

	if (isPublicPage) {
		return; // –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—É–±–ª–∏—á–Ω—ã–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
	}

	// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
	if (process.client) {
		const userStore = useUserStore();

		try {
			// 3. –ü–æ–∫–∞–∑ loader (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
			const { showLoader, hideLoader } = usePageLoader();
			if (!userStore.$state.isAuthInitialized) {
				showLoader();
			}

			// 4. –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
			if (!userStore.$state.isAuthInitialized) {
				await userStore.initAuth();
			}

			// 5. –°–∫—Ä—ã—Ç–∏–µ loader
			hideLoader();

			// 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
			if (!userStore.$state.isAuth || !userStore.$state.user?.id) {
				return navigateTo("/login");
			}
		} catch (error) {
			// 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
			hideLoader();
			return navigateTo("/login");
		}
	}
});
```

## –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /login ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /register ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ + –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /contacts ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ auth ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ + –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /contacts ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å loader ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ auth ‚Üí ‚ùå –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /docs ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å loader ‚Üí initAuth() ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí ‚úÖ/‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å userStore

Middleware —Ç–µ—Å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –º–µ—Ç–æ–¥–∞–º–∏ userStore:

```typescript
// userStore.initAuth() –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
async initAuth() {
  try {
    const refresh = await this.refreshToken();
    const user = await this.getUser();
    this.isAuth = !!user.body.user.id;
  } catch (error) {
    handleApiError(error);
  } finally {
    this.isAuthInitialized = true; // ‚Üê Middleware –∂–¥–µ—Ç —ç—Ç–æ–≥–æ —Ñ–ª–∞–≥–∞
  }
}
```

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å app.vue

Middleware –∑–∞–º–µ–Ω–∏–ª –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ `app.vue`, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è:

- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É**: –æ–¥–∏–Ω middleware –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
- **–õ—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö
- **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

## –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

```
middleware/
  ‚îî‚îÄ‚îÄ auth.global.ts           # –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

app.vue                        # –£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
store/user.store.ts           # –ú–µ—Ç–æ–¥—ã initAuth(), isAuthInitialized
components/PageLoader.vue     # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å loader
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### üéØ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- **–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: middleware –∂–¥–µ—Ç –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º —Ä–µ—à–µ–Ω–∏–π
- **–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Ñ–ª–∞–≥ `isAuth`, –∏ –Ω–∞–ª–∏—á–∏–µ `user.id`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ª—é–±–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É —Ä–µ–¥–∏—Ä–µ–∫—Ç—É

### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–£–º–Ω—ã–π loader**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º**: —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç SSR

### üé® UX

- **–ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã**: loader –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
- **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- **–ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã

## –û—Ç–ª–∞–¥–∫–∞

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ middleware –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```javascript
// –í –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö DevTools
console.log("Auth State:", {
	isAuth: userStore.$state.isAuth,
	isAuthInitialized: userStore.$state.isAuthInitialized,
	userId: userStore.$state.user?.id,
});
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

Middleware –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å:

- ‚úÖ Nuxt 3
- ‚úÖ Pinia store
- ‚úÖ Vue 3 Composition API
- ‚úÖ TypeScript
- ‚úÖ SSR/SPA —Ä–µ–∂–∏–º—ã
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

Middleware –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞—â–∏—Ç—É –≤—Å–µ—Ö –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü! üîê
